---
const { pathname } = Astro.url;

// Navigation items - Technical and Creative instead of general Projects
const navItems = [
  { href: '/', label: 'Home' },
  { href: '/projects/technical', label: 'Technical' },
  { href: '/projects/creative', label: 'Creative' },
  // { href: '/blog', label: 'BLOG' },
  { href: '/about', label: 'About' },
];


function isActive(href: string, pathname: string): boolean {
  if (href === '/') return pathname === '/';
  return pathname === href || pathname.startsWith(href + '/');
}
---

<!-- Nav Wrapper - Contains both nav layers -->
<div class="nav-wrapper">
  <!-- Primary Nav - Always visible, never hides -->
  <div class="primary-nav">
    <div class="primary-nav-container max-w-[92%] mx-auto px-2 border-b border-gray-200">
      <a href="/" class="primary-brand">
        <span class="name-english">
          <span class="letter" style="--i:0">S</span><span class="letter" style="--i:1">C</span><span class="letter" style="--i:2">O</span><span class="letter" style="--i:3">T</span><span class="letter" style="--i:4">T</span><span class="letter" style="--i:5">&nbsp;</span><span class="letter" style="--i:6">P</span><span class="letter" style="--i:7">A</span><span class="letter" style="--i:8">R</span><span class="letter" style="--i:9">K</span>
        </span>
        <span class="name-korean">
          <span class="letter" style="--i:0">박</span><span class="letter" style="--i:1">주</span><span class="letter" style="--i:2">원</span>
        </span>
      </a>
    </div>
  </div>

  <!-- Secondary Nav - Slides away on scroll -->
  <nav class="site-nav simple-clean" aria-label="Main navigation">
    <div class="nav-container max-w-[92%] py-2 mx-auto border-b border-gray-200 border-hidden">
      <div class="nav-inner">
        <div class="nav-tagline">
          <span>Engineer,</span>
          <span>Designer,</span>
          <span>Developer</span>
        </div>
        <ul class="nav-links" role="list">
          {navItems.map(item => {
            const active = isActive(item.href, pathname);
            return <li><a href={item.href} aria-current={active? 'page': undefined}>{item.label}</a></li>;
          })}
        </ul>
      </div>
    </div>
  </nav>
</div>


<script is:inline>
  // Nav positioning and scroll behavior
  (function(){
    const navWrapper = document.querySelector('.nav-wrapper');
    const primaryNav = document.querySelector('.primary-nav');
    const primaryBrand = document.querySelector('.primary-brand');
    const nav = document.querySelector('.site-nav');
    const navContainer = document.querySelector('.nav-container');
    if (!nav || !primaryNav || !navWrapper || !primaryBrand || !navContainer) return;
    
    // Phase 1: SCOTT PARK shrinks during scroll 0-150px
    // Phase 2: Secondary nav slides away after scroll > 150px (when SCOTT PARK is fully shrunk)
    const SHRINK_START = 0;
    const SHRINK_END = 150; // SCOTT PARK fully shrunk at this scroll position
    const SLIDE_THRESHOLD = 200; // Secondary nav starts sliding after this
    const BORDER_THRESHOLD = 20; // Show border after scrolling past this point
    
    // Dynamically set secondary nav position and body padding
    function updateNavPositions() {
      const primaryHeight = primaryNav.offsetHeight;
      
      // Set CSS custom properties for dynamic positioning - no gap between navs
      nav.style.top = (primaryHeight - 1) + 'px';
      
      // Update body padding based on current nav state
      const totalHeight = primaryHeight + nav.offsetHeight - 1;
      document.body.style.paddingTop = totalHeight + 'px';
    }
    
    // Initial positioning
    updateNavPositions();
    
    // Update on resize
    window.addEventListener('resize', updateNavPositions);
    
    let lastScrollY = window.scrollY;
    let ticking = false;
    
    function updateNavOnScroll() {
      const currentScrollY = window.scrollY;
      
      // === PHASE 1: SCOTT PARK shrink animation ===
      // Calculate shrink progress (0 = full size, 1 = minimum size)
      const shrinkProgress = Math.min(1, Math.max(0, (currentScrollY - SHRINK_START) / (SHRINK_END - SHRINK_START)));
      
      // Apply shrink class when scrolling has started
      if (shrinkProgress > 0) {
        primaryNav.classList.add('primary-shrunk');
      } else {
        primaryNav.classList.remove('primary-shrunk');
      }
      
      // Set CSS custom property for smooth size interpolation
      primaryBrand.style.setProperty('--shrink-progress', shrinkProgress);
      
      // Update nav positions as primary nav height changes
      updateNavPositions();
      
      // === Border visibility: hide border near top of page ===
      if (currentScrollY > BORDER_THRESHOLD) {
        navContainer.classList.remove('border-hidden');
      } else {
        navContainer.classList.add('border-hidden');
      }
      
      // === PHASE 2: Secondary nav slide animation ===
      // Only trigger after SCOTT PARK is fully shrunk
      
      // Show nav at top of page or when SCOTT PARK hasn't fully shrunk
      if (currentScrollY < SHRINK_END) {
        nav.classList.remove('nav-hidden');
      }
      // Hide nav when scrolling down (only after shrink is complete)
      else if (currentScrollY > lastScrollY && currentScrollY > SLIDE_THRESHOLD) {
        nav.classList.add('nav-hidden');
      } 
      // Show nav when scrolling up
      else if (currentScrollY < lastScrollY) {
        nav.classList.remove('nav-hidden');
      }
      
      lastScrollY = currentScrollY;
      ticking = false;
    }
    
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateNavOnScroll);
        ticking = true;
      }
    }
    
    // Check if we're over a dark section and invert colors
    const invertTargets = document.querySelectorAll('[data-nav-invert]');
    if (invertTargets.length) {
      const observer = new IntersectionObserver((entries) => {
        let invert = false;
        for (const e of entries) { 
          if (e.isIntersecting) { 
            invert = true; 
            break; 
          } 
        }
        nav.classList.toggle('invert', invert);
      }, { root: null, threshold: 0.05, rootMargin: '-10% 0px -85% 0px' });
      invertTargets.forEach(t => observer.observe(t));
    }
    
    // Add scroll listener
    window.addEventListener('scroll', onScroll, { passive: true });
    
    // Initial state
    updateNavOnScroll();
    
    // Clean up on page navigation
    document.addEventListener('astro:before-swap', () => {
      window.removeEventListener('scroll', onScroll);
      window.removeEventListener('resize', updateNavPositions);
    });
  })();
</script>

<style>
  /* Nav Wrapper */
  .nav-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    pointer-events: none; /* Allow clicks to pass through wrapper */
  }

  /* Primary Nav - Always visible */
  .primary-nav {
    position: relative;
    z-index: 70;
    pointer-events: none; /* Allow clicks to pass through */
    background: var(--bg-color);
  }

  .primary-nav-container {
    padding-top: 0.75rem;
    padding-bottom: 0.5rem;
    pointer-events: none; /* Allow clicks to pass through */
  }

  .primary-brand {
    --shrink-progress: 0;
    --full-size: 14.75vw;
    --min-size: 2.5rem;
    
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    /* Interpolate between full-size and min-size based on shrink-progress */
    font-size: calc(var(--full-size) - (var(--full-size) - var(--min-size)) * var(--shrink-progress));
    font-weight: 700;
    color: var(--color-text-primary, #1e1e1e);
    text-decoration: none;
    letter-spacing: -0.02em;
    line-height: 1;
    display: inline-block;
    white-space: nowrap;
    position: relative;
    pointer-events: auto; /* Re-enable clicks only on the brand link */
  }

  /* Letter-by-letter animation */
  .name-english,
  .name-korean {
    display: inline-block;
  }

  .name-korean {
    position: absolute;
    left: 0;
    top: 0;
  }

  .letter {
    display: inline-block;
    transition: opacity 0.08s ease;
  }

  /* === DEFAULT STATE (not hovering) === */
  /* English visible with staggered fade-in delay (for when hover ends) */
  .name-english .letter {
    opacity: 1;
    transition-delay: calc(0.12s + var(--i) * 0.03s);
  }

  /* Korean hidden with staggered fade-out delay (for when hover ends) */
  .name-korean .letter {
    opacity: 0;
    transition-delay: calc(var(--i) * 0.04s);
  }

  /* === HOVER STATE === */
  /* English letters fade out with staggered delay */
  .primary-brand:hover .name-english .letter {
    opacity: 0;
    transition-delay: calc(var(--i) * 0.03s);
  }

  /* Korean letters fade in after "SCOTT" fades out */
  .primary-brand:hover .name-korean .letter {
    opacity: 1;
    transition-delay: calc(0.18s + var(--i) * 0.06s);
  }

  /* Secondary Nav - Slides away on scroll */
  .site-nav {
    position: fixed;
    left: 0;
    right: 0;
    z-index: 60;
    padding-top: 0;
    padding-bottom: 0;
    background: var(--bg-color);
    transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translate3d(0, 0, 0);
    pointer-events: auto; /* Re-enable clicks on secondary nav */
    will-change: transform;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-transform-style: preserve-3d;
  }

  .site-nav.nav-hidden {
    transform: translate3d(0, calc(-100% - 2px), 0);
    pointer-events: none;
  }

  .nav-container {
    padding-bottom: 0.5rem;
    transition: border-color 0.3s ease;
  }

  .nav-container.border-hidden {
    border-color: transparent !important;
  }

  .nav-inner {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    width: 100%;
  }

  .nav-tagline {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    color: #6b7280;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.01em;
    line-height: 1.3;
  }

  .nav-links {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 0;
  }

  .nav-links li {
    position: relative;
  }

  .nav-links a {
    display: block;
    padding: 0;
    text-decoration: none;
    color: #6b7280;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.01em;
    line-height: 1.3;
    transition: color 0.2s ease;
    position: relative;
  }

  .nav-links a:hover {
    color: var(--color-text-primary, #1e1e1e);
  }

  /* Arrow indicator for active page */
  .nav-links a[aria-current="page"]::before {
    content: '▶';
    position: absolute;
    left: -1.2rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-primary, #1e1e1e);
    font-size: 0.65rem;
    line-height: 1;
  }

  .nav-links a[aria-current="page"] {
    color: var(--color-text-primary, #1e1e1e);
    font-weight: 500;
  }

  /* Dark theme / invert state for secondary nav */
  .site-nav.invert {
    background: rgba(0, 0, 0, 0.95);
  }

  .site-nav.invert.nav-transparent {
    background: transparent;
  }

  .site-nav.invert .nav-links a {
    color: #d1d5db;
  }

  .site-nav.invert .nav-links a:hover {
    color: #f9fafb;
  }

  .site-nav.invert .nav-links a[aria-current="page"] {
    color: #f9fafb;
  }

  .site-nav.invert .nav-links a[aria-current="page"]::before {
    color: #f9fafb;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .primary-nav-container {
      padding-top: 0.3rem;
      padding-bottom: 0.5rem;
      text-align: center;
    }

    .site-nav {
      padding: 0.4rem 0 0 0;
    }
    
    .nav-links a {
      font-size: 0.75rem;
    }
  }

  @media (max-width: 480px) {
    .nav-links a {
      font-size: 0.7rem;
      letter-spacing: 0.02em;
    }
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .site-nav {
      transition: none;
    }
    
    .nav-links a {
      transition: none;
    }
  }
</style>
